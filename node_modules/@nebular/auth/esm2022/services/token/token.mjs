import { urlBase64Decode } from '../../helpers';
export class NbAuthToken {
    constructor() {
        this.payload = null;
    }
    getName() {
        return this.constructor.NAME;
    }
    getPayload() {
        return this.payload;
    }
}
export class NbAuthTokenNotFoundError extends Error {
    constructor(message) {
        super(message);
        Object.setPrototypeOf(this, new.target.prototype);
    }
}
export class NbAuthIllegalTokenError extends Error {
    constructor(message) {
        super(message);
        Object.setPrototypeOf(this, new.target.prototype);
    }
}
export class NbAuthEmptyTokenError extends NbAuthIllegalTokenError {
    constructor(message) {
        super(message);
        Object.setPrototypeOf(this, new.target.prototype);
    }
}
export class NbAuthIllegalJWTTokenError extends NbAuthIllegalTokenError {
    constructor(message) {
        super(message);
        Object.setPrototypeOf(this, new.target.prototype);
    }
}
export function nbAuthCreateToken(tokenClass, token, ownerStrategyName, createdAt) {
    return new tokenClass(token, ownerStrategyName, createdAt);
}
export function decodeJwtPayload(payload) {
    if (payload.length === 0) {
        throw new NbAuthEmptyTokenError('Cannot extract from an empty payload.');
    }
    const parts = payload.split('.');
    if (parts.length !== 3) {
        throw new NbAuthIllegalJWTTokenError(`The payload ${payload} is not valid JWT payload and must consist of three parts.`);
    }
    let decoded;
    try {
        decoded = urlBase64Decode(parts[1]);
    }
    catch (e) {
        throw new NbAuthIllegalJWTTokenError(`The payload ${payload} is not valid JWT payload and cannot be parsed.`);
    }
    if (!decoded) {
        throw new NbAuthIllegalJWTTokenError(`The payload ${payload} is not valid JWT payload and cannot be decoded.`);
    }
    return JSON.parse(decoded);
}
/**
 * Wrapper for simple (text) token
 */
export class NbAuthSimpleToken extends NbAuthToken {
    static { this.NAME = 'nb:auth:simple:token'; }
    constructor(token, ownerStrategyName, createdAt) {
        super();
        this.token = token;
        this.ownerStrategyName = ownerStrategyName;
        this.createdAt = createdAt;
        try {
            this.parsePayload();
        }
        catch (err) {
            if (!(err instanceof NbAuthTokenNotFoundError)) {
                // token is present but has got a problem, including illegal
                throw err;
            }
        }
        this.createdAt = this.prepareCreatedAt(createdAt);
    }
    parsePayload() {
        this.payload = null;
    }
    prepareCreatedAt(date) {
        return date ? date : new Date();
    }
    /**
     * Returns the token's creation date
     * @returns {Date}
     */
    getCreatedAt() {
        return this.createdAt;
    }
    /**
     * Returns the token value
     * @returns string
     */
    getValue() {
        return this.token;
    }
    getOwnerStrategyName() {
        return this.ownerStrategyName;
    }
    /**
     * Is non empty and valid
     * @returns {boolean}
     */
    isValid() {
        return !!this.getValue();
    }
    /**
     * Validate value and convert to string, if value is not valid return empty string
     * @returns {string}
     */
    toString() {
        return !!this.token ? this.token : '';
    }
}
/**
 * Wrapper for JWT token with additional methods.
 */
export class NbAuthJWTToken extends NbAuthSimpleToken {
    static { this.NAME = 'nb:auth:jwt:token'; }
    /**
     * for JWT token, the iat (issued at) field of the token payload contains the creation Date
     */
    prepareCreatedAt(date) {
        const decoded = this.getPayload();
        return decoded && decoded.iat ? new Date(Number(decoded.iat) * 1000) : super.prepareCreatedAt(date);
    }
    /**
     * Returns payload object
     * @returns any
     */
    parsePayload() {
        if (!this.token) {
            throw new NbAuthTokenNotFoundError('Token not found. ');
        }
        this.payload = decodeJwtPayload(this.token);
    }
    /**
     * Returns expiration date
     * @returns Date
     */
    getTokenExpDate() {
        const decoded = this.getPayload();
        if (decoded && !decoded.hasOwnProperty('exp')) {
            return null;
        }
        const date = new Date(0);
        date.setUTCSeconds(decoded.exp); // 'cause jwt token are set in seconds
        return date;
    }
    /**
     * Is data expired
     * @returns {boolean}
     */
    isValid() {
        return super.isValid() && (!this.getTokenExpDate() || new Date() < this.getTokenExpDate());
    }
}
const prepareOAuth2Token = (data) => {
    if (typeof data === 'string') {
        try {
            return JSON.parse(data);
        }
        catch (e) { }
    }
    return data;
};
/**
 * Wrapper for OAuth2 token whose access_token is a JWT Token
 */
export class NbAuthOAuth2Token extends NbAuthSimpleToken {
    static { this.NAME = 'nb:auth:oauth2:token'; }
    constructor(data = {}, ownerStrategyName, createdAt) {
        // we may get it as string when retrieving from a storage
        super(prepareOAuth2Token(data), ownerStrategyName, createdAt);
    }
    /**
     * Returns the token value
     * @returns string
     */
    getValue() {
        return this.token.access_token;
    }
    /**
     * Returns the refresh token
     * @returns string
     */
    getRefreshToken() {
        return this.token.refresh_token;
    }
    /**
     *  put refreshToken in the token payload
      * @param refreshToken
     */
    setRefreshToken(refreshToken) {
        this.token.refresh_token = refreshToken;
    }
    /**
     * Parses token payload
     * @returns any
     */
    parsePayload() {
        if (!this.token) {
            throw new NbAuthTokenNotFoundError('Token not found.');
        }
        else {
            if (!Object.keys(this.token).length) {
                throw new NbAuthEmptyTokenError('Cannot extract payload from an empty token.');
            }
        }
        this.payload = this.token;
    }
    /**
     * Returns the token type
     * @returns string
     */
    getType() {
        return this.token.token_type;
    }
    /**
     * Is data expired
     * @returns {boolean}
     */
    isValid() {
        return super.isValid() && (!this.getTokenExpDate() || new Date() < this.getTokenExpDate());
    }
    /**
     * Returns expiration date
     * @returns Date
     */
    getTokenExpDate() {
        if (!this.token.hasOwnProperty('expires_in')) {
            return null;
        }
        return new Date(this.createdAt.getTime() + Number(this.token.expires_in) * 1000);
    }
    /**
     * Convert to string
     * @returns {string}
     */
    toString() {
        return JSON.stringify(this.token);
    }
}
/**
 * Wrapper for OAuth2 token embedding JWT tokens
 */
export class NbAuthOAuth2JWTToken extends NbAuthOAuth2Token {
    static { this.NAME = 'nb:auth:oauth2:jwt:token'; }
    parsePayload() {
        super.parsePayload();
        this.parseAccessTokenPayload();
    }
    parseAccessTokenPayload() {
        const accessToken = this.getValue();
        if (!accessToken) {
            throw new NbAuthTokenNotFoundError('access_token key not found.');
        }
        this.accessTokenPayload = decodeJwtPayload(accessToken);
    }
    /**
     * Returns access token payload
     * @returns any
     */
    getAccessTokenPayload() {
        return this.accessTokenPayload;
    }
    /**
     * for Oauth2 JWT token, the iat (issued at) field of the access_token payload
     */
    prepareCreatedAt(date) {
        const payload = this.accessTokenPayload;
        return payload && payload.iat ? new Date(Number(payload.iat) * 1000) : super.prepareCreatedAt(date);
    }
    /**
     * Is token valid
     * @returns {boolean}
     */
    isValid() {
        return this.accessTokenPayload && super.isValid();
    }
    /**
     * Returns expiration date :
     * - exp if set,
     * - super.getExpDate() otherwise
     * @returns Date
     */
    getTokenExpDate() {
        if (this.accessTokenPayload && this.accessTokenPayload.hasOwnProperty('exp')) {
            const date = new Date(0);
            date.setUTCSeconds(this.accessTokenPayload.exp);
            return date;
        }
        else {
            return super.getTokenExpDate();
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9rZW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvZnJhbWV3b3JrL2F1dGgvc2VydmljZXMvdG9rZW4vdG9rZW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVoRCxNQUFNLE9BQWdCLFdBQVc7SUFBakM7UUFFWSxZQUFPLEdBQVEsSUFBSSxDQUFDO0lBZ0JoQyxDQUFDO0lBUEMsT0FBTztRQUNMLE9BQVEsSUFBSSxDQUFDLFdBQWdDLENBQUMsSUFBSSxDQUFDO0lBQ3JELENBQUM7SUFFRCxVQUFVO1FBQ1IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3RCLENBQUM7Q0FDRjtBQUVELE1BQU0sT0FBTyx3QkFBeUIsU0FBUSxLQUFLO0lBQ2pELFlBQVksT0FBZTtRQUN6QixLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDZixNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3BELENBQUM7Q0FDRjtBQUVELE1BQU0sT0FBTyx1QkFBd0IsU0FBUSxLQUFLO0lBQ2hELFlBQVksT0FBZTtRQUN6QixLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDZixNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3BELENBQUM7Q0FDRjtBQUVELE1BQU0sT0FBTyxxQkFBc0IsU0FBUSx1QkFBdUI7SUFDaEUsWUFBWSxPQUFlO1FBQ3pCLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNmLE1BQU0sQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDcEQsQ0FBQztDQUNGO0FBRUQsTUFBTSxPQUFPLDBCQUEyQixTQUFRLHVCQUF1QjtJQUNy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b250ZW50IjpbImltcG9ydCB7IHVybEJhc2U2NERlY29kZSB9IGZyb20gJy4uLy4uL2hlbHBlcnMnO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgTmJBdXRoVG9rZW4ge1xuXG4gIHByb3RlY3RlZCBwYXlsb2FkOiBhbnkgPSBudWxsO1xuXG4gIGFic3RyYWN0IGdldFZhbHVlKCk6IHN0cmluZztcbiAgYWJzdHJhY3QgaXNWYWxpZCgpOiBib29sZWFuO1xuICAvLyB0aGUgc3RyYXRlZ3kgbmFtZSB1c2VkIHRvIGFjcXVpcmUgdGhpcyB0b2tlbiAobmVlZGVkIGZvciByZWZyZXNoaW5nIHRva2VuKVxuICBhYnN0cmFjdCBnZXRPd25lclN0cmF0ZWd5TmFtZSgpOiBzdHJpbmc7XG4gIGFic3RyYWN0IGdldENyZWF0ZWRBdCgpOiBEYXRlO1xuICBhYnN0cmFjdCB0b1N0cmluZygpOiBzdHJpbmc7XG5cbiAgZ2V0TmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiAodGhpcy5jb25zdHJ1Y3RvciBhcyBOYkF1dGhUb2tlbkNsYXNzKS5OQU1FO1xuICB9XG5cbiAgZ2V0UGF5bG9hZCgpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLnBheWxvYWQ7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIE5iQXV0aFRva2VuTm90Rm91bmRFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgY29uc3RydWN0b3IobWVzc2FnZTogc3RyaW5nKSB7XG4gICAgc3VwZXIobWVzc2FnZSk7XG4gICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKHRoaXMsIG5ldy50YXJnZXQucHJvdG90eXBlKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgTmJBdXRoSWxsZWdhbFRva2VuRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG4gIGNvbnN0cnVjdG9yKG1lc3NhZ2U6IHN0cmluZykge1xuICAgIHN1cGVyKG1lc3NhZ2UpO1xuICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZih0aGlzLCBuZXcudGFyZ2V0LnByb3RvdHlwZSk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIE5iQXV0aEVtcHR5VG9rZW5FcnJvciBleHRlbmRzIE5iQXV0aElsbGVnYWxUb2tlbkVycm9yIHtcbiAgY29uc3RydWN0b3IobWVzc2FnZTogc3RyaW5nKSB7XG4gICAgc3VwZXIobWVzc2FnZSk7XG4gICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKHRoaXMsIG5ldy50YXJnZXQucHJvdG90eXBlKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgTmJBdXRoSWxsZWdhbEpXVFRva2VuRXJyb3IgZXh0ZW5kcyBOYkF1dGhJbGxlZ2FsVG9rZW5FcnJvciB7XG4gIGNvbnN0cnVjdG9yKG1lc3NhZ2U6IHN0cmluZykge1xuICAgIHN1cGVyKG1lc3NhZ2UpO1xuICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZih0aGlzLCBuZXcudGFyZ2V0LnByb3RvdHlwZSk7XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBOYkF1dGhSZWZyZXNoYWJsZVRva2VuIHtcbiAgZ2V0UmVmcmVzaFRva2VuKCk6IHN0cmluZztcbiAgc2V0UmVmcmVzaFRva2VuKHJlZnJlc2hUb2tlbjogc3RyaW5nKTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOYkF1dGhUb2tlbkNsYXNzPFQgPSBOYkF1dGhUb2tlbj4ge1xuICBOQU1FOiBzdHJpbmc7XG4gIG5ldyAocmF3OiBhbnksIHN0cmF0ZWd5TmFtZTogc3RyaW5nLCBleHBEYXRlPzogRGF0ZSk6IFQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBuYkF1dGhDcmVhdGVUb2tlbjxUIGV4dGVuZHMgTmJBdXRoVG9rZW4+KHRva2VuQ2xhc3M6IE5iQXV0aFRva2VuQ2xhc3M8VD4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW46IGFueSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvd25lclN0cmF0ZWd5TmFtZTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZWRBdD86IERhdGUpIHtcbiAgcmV0dXJuIG5ldyB0b2tlbkNsYXNzKHRva2VuLCBvd25lclN0cmF0ZWd5TmFtZSwgY3JlYXRlZEF0KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlY29kZUp3dFBheWxvYWQocGF5bG9hZDogc3RyaW5nKTogYW55IHtcblxuICBpZiAocGF5bG9hZC5sZW5ndGggPT09IDApIHtcbiAgICB0aHJvdyBuZXcgTmJBdXRoRW1wdHlUb2tlbkVycm9yKCdDYW5ub3QgZXh0cmFjdCBmcm9tIGFuIGVtcHR5IHBheWxvYWQuJyk7XG4gIH1cblxuICBjb25zdCBwYXJ0cyA9IHBheWxvYWQuc3BsaXQoJy4nKTtcblxuICBpZiAocGFydHMubGVuZ3RoICE9PSAzKSB7XG4gICAgdGhyb3cgbmV3IE5iQXV0aElsbGVnYWxKV1RUb2tlbkVycm9yKFxuICAgICAgYFRoZSBwYXlsb2FkICR7cGF5bG9hZH0gaXMgbm90IHZhbGlkIEpXVCBwYXlsb2FkIGFuZCBtdXN0IGNvbnNpc3Qgb2YgdGhyZWUgcGFydHMuYCk7XG4gIH1cblxuICBsZXQgZGVjb2RlZDtcbiAgdHJ5IHtcbiAgICBkZWNvZGVkID0gdXJsQmFzZTY0RGVjb2RlKHBhcnRzWzFdKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBOYkF1dGhJbGxlZ2FsSldUVG9rZW5FcnJvcihcbiAgICAgIGBUaGUgcGF5bG9hZCAke3BheWxvYWR9IGlzIG5vdCB2YWxpZCBKV1QgcGF5bG9hZCBhbmQgY2Fubm90IGJlIHBhcnNlZC5gKTtcbiAgfVxuXG4gIGlmICghZGVjb2RlZCkge1xuICAgIHRocm93IG5ldyBOYkF1dGhJbGxlZ2FsSldUVG9rZW5FcnJvcihcbiAgICAgIGBUaGUgcGF5bG9hZCAke3BheWxvYWR9IGlzIG5vdCB2YWxpZCBKV1QgcGF5bG9hZCBhbmQgY2Fubm90IGJlIGRlY29kZWQuYCk7XG4gIH1cbiAgcmV0dXJuIEpTT04ucGFyc2UoZGVjb2RlZCk7XG59XG5cbi8qKlxuICogV3JhcHBlciBmb3Igc2ltcGxlICh0ZXh0KSB0b2tlblxuICovXG5leHBvcnQgY2xhc3MgTmJBdXRoU2ltcGxlVG9rZW4gZXh0ZW5kcyBOYkF1dGhUb2tlbiB7XG5cbiAgc3RhdGljIE5BTUUgPSAnbmI6YXV0aDpzaW1wbGU6dG9rZW4nO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCByZWFkb25seSB0b2tlbjogYW55LFxuICAgICAgICAgICAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgb3duZXJTdHJhdGVneU5hbWU6IHN0cmluZyxcbiAgICAgICAgICAgICAgcHJvdGVjdGVkIGNyZWF0ZWRBdD86IERhdGUpIHtcbiAgICBzdXBlcigpO1xuICAgIHRyeSB7XG4gICAgICB0aGlzLnBhcnNlUGF5bG9hZCgpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKCEoZXJyIGluc3RhbmNlb2YgTmJBdXRoVG9rZW5Ob3RGb3VuZEVycm9yKSkge1xuICAgICAgICAvLyB0b2tlbiBpcyBwcmVzZW50IGJ1dCBoYXMgZ290IGEgcHJvYmxlbSwgaW5jbHVkaW5nIGlsbGVnYWxcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmNyZWF0ZWRBdCA9IHRoaXMucHJlcGFyZUNyZWF0ZWRBdChjcmVhdGVkQXQpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlUGF5bG9hZCgpOiBhbnkge1xuICAgIHRoaXMucGF5bG9hZCA9IG51bGw7XG4gIH1cblxuICBwcm90ZWN0ZWQgcHJlcGFyZUNyZWF0ZWRBdChkYXRlOiBEYXRlKSB7XG4gICAgcmV0dXJuIGRhdGUgPyBkYXRlIDogbmV3IERhdGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSB0b2tlbidzIGNyZWF0aW9uIGRhdGVcbiAgICogQHJldHVybnMge0RhdGV9XG4gICAqL1xuICBnZXRDcmVhdGVkQXQoKTogRGF0ZSB7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlZEF0O1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHRva2VuIHZhbHVlXG4gICAqIEByZXR1cm5zIHN0cmluZ1xuICAgKi9cbiAgZ2V0VmFsdWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy50b2tlbjtcbiAgfVxuXG4gIGdldE93bmVyU3RyYXRlZ3lOYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMub3duZXJTdHJhdGVneU5hbWU7XG4gIH1cblxuICAvKipcbiAgICogSXMgbm9uIGVtcHR5IGFuZCB2YWxpZFxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICovXG4gIGlzVmFsaWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICEhdGhpcy5nZXRWYWx1ZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIHZhbHVlIGFuZCBjb252ZXJ0IHRvIHN0cmluZywgaWYgdmFsdWUgaXMgbm90IHZhbGlkIHJldHVybiBlbXB0eSBzdHJpbmdcbiAgICogQHJldHVybnMge3N0cmluZ31cbiAgICovXG4gIHRvU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuICEhdGhpcy50b2tlbiA/IHRoaXMudG9rZW4gOiAnJztcbiAgfVxufVxuXG4vKipcbiAqIFdyYXBwZXIgZm9yIEpXVCB0b2tlbiB3aXRoIGFkZGl0aW9uYWwgbWV0aG9kcy5cbiAqL1xuZXhwb3J0IGNsYXNzIE5iQXV0aEpXVFRva2VuIGV4dGVuZHMgTmJBdXRoU2ltcGxlVG9rZW4ge1xuXG4gIHN0YXRpYyBOQU1FID0gJ25iOmF1dGg6and0OnRva2VuJztcblxuICAvKipcbiAgICogZm9yIEpXVCB0b2tlbiwgdGhlIGlhdCAoaXNzdWVkIGF0KSBmaWVsZCBvZiB0aGUgdG9rZW4gcGF5bG9hZCBjb250YWlucyB0aGUgY3JlYXRpb24gRGF0ZVxuICAgKi9cbiAgcHJvdGVjdGVkIHByZXBhcmVDcmVhdGVkQXQoZGF0ZTogRGF0ZSkge1xuICAgICAgY29uc3QgZGVjb2RlZCA9IHRoaXMuZ2V0UGF5bG9hZCgpO1xuICAgICAgcmV0dXJuIGRlY29kZWQgJiYgZGVjb2RlZC5pYXQgPyBuZXcgRGF0ZShOdW1iZXIoZGVjb2RlZC5pYXQpICogMTAwMCkgOiBzdXBlci5wcmVwYXJlQ3JlYXRlZEF0KGRhdGUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgcGF5bG9hZCBvYmplY3RcbiAgICogQHJldHVybnMgYW55XG4gICAqL1xuICBwcm90ZWN0ZWQgcGFyc2VQYXlsb2FkKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy50b2tlbikge1xuICAgICAgdGhyb3cgbmV3IE5iQXV0aFRva2VuTm90Rm91bmRFcnJvcignVG9rZW4gbm90IGZvdW5kLiAnKVxuICAgIH1cbiAgICB0aGlzLnBheWxvYWQgPSBkZWNvZGVKd3RQYXlsb2FkKHRoaXMudG9rZW4pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgZXhwaXJhdGlvbiBkYXRlXG4gICAqIEByZXR1cm5zIERhdGVcbiAgICovXG4gIGdldFRva2VuRXhwRGF0ZSgpOiBEYXRlIHtcbiAgICBjb25zdCBkZWNvZGVkID0gdGhpcy5nZXRQYXlsb2FkKCk7XG4gICAgaWYgKGRlY29kZWQgJiYgIWRlY29kZWQuaGFzT3duUHJvcGVydHkoJ2V4cCcpKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKDApO1xuICAgIGRhdGUuc2V0VVRDU2Vjb25kcyhkZWNvZGVkLmV4cCk7IC8vICdjYXVzZSBqd3QgdG9rZW4gYXJlIHNldCBpbiBzZWNvbmRzXG4gICAgcmV0dXJuIGRhdGU7XG4gIH1cblxuICAvKipcbiAgICogSXMgZGF0YSBleHBpcmVkXG4gICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgKi9cbiAgaXNWYWxpZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gc3VwZXIuaXNWYWxpZCgpICYmICghdGhpcy5nZXRUb2tlbkV4cERhdGUoKSB8fCBuZXcgRGF0ZSgpIDwgdGhpcy5nZXRUb2tlbkV4cERhdGUoKSk7XG4gIH1cbn1cblxuY29uc3QgcHJlcGFyZU9BdXRoMlRva2VuID0gKGRhdGEpID0+IHtcbiAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShkYXRhKTtcbiAgICB9IGNhdGNoIChlKSB7fVxuICB9XG4gIHJldHVybiBkYXRhO1xufTtcblxuLyoqXG4gKiBXcmFwcGVyIGZvciBPQXV0aDIgdG9rZW4gd2hvc2UgYWNjZXNzX3Rva2VuIGlzIGEgSldUIFRva2VuXG4gKi9cbmV4cG9ydCBjbGFzcyBOYkF1dGhPQXV0aDJUb2tlbiBleHRlbmRzIE5iQXV0aFNpbXBsZVRva2VuIHtcblxuICBzdGF0aWMgTkFNRSA9ICduYjphdXRoOm9hdXRoMjp0b2tlbic7XG5cbiAgY29uc3RydWN0b3IoIGRhdGE6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nfG51bWJlciB9fHN0cmluZyA9IHt9LFxuICAgICAgICAgICAgICAgb3duZXJTdHJhdGVneU5hbWU6IHN0cmluZyxcbiAgICAgICAgICAgICAgIGNyZWF0ZWRBdD86IERhdGUpIHtcblxuICAgIC8vIHdlIG1heSBnZXQgaXQgYXMgc3RyaW5nIHdoZW4gcmV0cmlldmluZyBmcm9tIGEgc3RvcmFnZVxuICAgIHN1cGVyKHByZXBhcmVPQXV0aDJUb2tlbihkYXRhKSwgb3duZXJTdHJhdGVneU5hbWUsIGNyZWF0ZWRBdCk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgdG9rZW4gdmFsdWVcbiAgICogQHJldHVybnMgc3RyaW5nXG4gICAqL1xuICBnZXRWYWx1ZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnRva2VuLmFjY2Vzc190b2tlbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSByZWZyZXNoIHRva2VuXG4gICAqIEByZXR1cm5zIHN0cmluZ1xuICAgKi9cbiAgZ2V0UmVmcmVzaFRva2VuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMudG9rZW4ucmVmcmVzaF90b2tlbjtcbiAgfVxuXG4gIC8qKlxuICAgKiAgcHV0IHJlZnJlc2hUb2tlbiBpbiB0aGUgdG9rZW4gcGF5bG9hZFxuICAgICogQHBhcmFtIHJlZnJlc2hUb2tlblxuICAgKi9cbiAgc2V0UmVmcmVzaFRva2VuKHJlZnJlc2hUb2tlbjogc3RyaW5nKSB7XG4gICAgdGhpcy50b2tlbi5yZWZyZXNoX3Rva2VuID0gcmVmcmVzaFRva2VuO1xuICB9XG5cbiAgLyoqXG4gICAqIFBhcnNlcyB0b2tlbiBwYXlsb2FkXG4gICAqIEByZXR1cm5zIGFueVxuICAgKi9cbiAgcHJvdGVjdGVkIHBhcnNlUGF5bG9hZCgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMudG9rZW4pIHtcbiAgICAgIHRocm93IG5ldyBOYkF1dGhUb2tlbk5vdEZvdW5kRXJyb3IoJ1Rva2VuIG5vdCBmb3VuZC4nKVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIU9iamVjdC5rZXlzKHRoaXMudG9rZW4pLmxlbmd0aCkge1xuICAgICAgICB0aHJvdyBuZXcgTmJBdXRoRW1wdHlUb2tlbkVycm9yKCdDYW5ub3QgZXh0cmFjdCBwYXlsb2FkIGZyb20gYW4gZW1wdHkgdG9rZW4uJyk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMucGF5bG9hZCA9IHRoaXMudG9rZW47XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgdG9rZW4gdHlwZVxuICAgKiBAcmV0dXJucyBzdHJpbmdcbiAgICovXG4gIGdldFR5cGUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy50b2tlbi50b2tlbl90eXBlO1xuICB9XG5cbiAgLyoqXG4gICAqIElzIGRhdGEgZXhwaXJlZFxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICovXG4gIGlzVmFsaWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHN1cGVyLmlzVmFsaWQoKSAmJiAoIXRoaXMuZ2V0VG9rZW5FeHBEYXRlKCkgfHwgbmV3IERhdGUoKSA8IHRoaXMuZ2V0VG9rZW5FeHBEYXRlKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgZXhwaXJhdGlvbiBkYXRlXG4gICAqIEByZXR1cm5zIERhdGVcbiAgICovXG4gIGdldFRva2VuRXhwRGF0ZSgpOiBEYXRlIHtcbiAgICBpZiAoIXRoaXMudG9rZW4uaGFzT3duUHJvcGVydHkoJ2V4cGlyZXNfaW4nKSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHJldHVybiBuZXcgRGF0ZSh0aGlzLmNyZWF0ZWRBdC5nZXRUaW1lKCkgKyBOdW1iZXIodGhpcy50b2tlbi5leHBpcmVzX2luKSAqIDEwMDApO1xufVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0IHRvIHN0cmluZ1xuICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgKi9cbiAgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodGhpcy50b2tlbik7XG4gIH1cbn1cblxuLyoqXG4gKiBXcmFwcGVyIGZvciBPQXV0aDIgdG9rZW4gZW1iZWRkaW5nIEpXVCB0b2tlbnNcbiAqL1xuZXhwb3J0IGNsYXNzIE5iQXV0aE9BdXRoMkpXVFRva2VuIGV4dGVuZHMgTmJBdXRoT0F1dGgyVG9rZW4ge1xuXG4gIHN0YXRpYyBOQU1FID0gJ25iOmF1dGg6b2F1dGgyOmp3dDp0b2tlbic7XG5cbiAgcHJvdGVjdGVkIGFjY2Vzc1Rva2VuUGF5bG9hZDogYW55O1xuXG4gIHByb3RlY3RlZCBwYXJzZVBheWxvYWQoKTogdm9pZCB7XG4gICAgc3VwZXIucGFyc2VQYXlsb2FkKCk7XG4gICAgdGhpcy5wYXJzZUFjY2Vzc1Rva2VuUGF5bG9hZCgpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlQWNjZXNzVG9rZW5QYXlsb2FkKCk6IGFueSB7XG4gICAgY29uc3QgYWNjZXNzVG9rZW4gPSB0aGlzLmdldFZhbHVlKCk7XG4gICAgaWYgKCFhY2Nlc3NUb2tlbikge1xuICAgICAgdGhyb3cgbmV3IE5iQXV0aFRva2VuTm90Rm91bmRFcnJvcignYWNjZXNzX3Rva2VuIGtleSBub3QgZm91bmQuJylcbiAgICB9XG4gICAgdGhpcy5hY2Nlc3NUb2tlblBheWxvYWQgPSBkZWNvZGVKd3RQYXlsb2FkKGFjY2Vzc1Rva2VuKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFjY2VzcyB0b2tlbiBwYXlsb2FkXG4gICAqIEByZXR1cm5zIGFueVxuICAgKi9cbiAgZ2V0QWNjZXNzVG9rZW5QYXlsb2FkKCk6IGFueSB7XG4gICAgcmV0dXJuIHRoaXMuYWNjZXNzVG9rZW5QYXlsb2FkO1xuICB9XG5cbiAgLyoqXG4gICAqIGZvciBPYXV0aDIgSldUIHRva2VuLCB0aGUgaWF0IChpc3N1ZWQgYXQpIGZpZWxkIG9mIHRoZSBhY2Nlc3NfdG9rZW4gcGF5bG9hZFxuICAgKi9cbiAgcHJvdGVjdGVkIHByZXBhcmVDcmVhdGVkQXQoZGF0ZTogRGF0ZSkge1xuICAgIGNvbnN0IHBheWxvYWQgPSB0aGlzLmFjY2Vzc1Rva2VuUGF5bG9hZDtcbiAgICByZXR1cm4gcGF5bG9hZCAmJiBwYXlsb2FkLmlhdCA/IG5ldyBEYXRlKE51bWJlcihwYXlsb2FkLmlhdCkgKiAxMDAwKSA6IHN1cGVyLnByZXBhcmVDcmVhdGVkQXQoZGF0ZSk7XG4gIH1cblxuICAvKipcbiAgICogSXMgdG9rZW4gdmFsaWRcbiAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAqL1xuICBpc1ZhbGlkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmFjY2Vzc1Rva2VuUGF5bG9hZCAmJiBzdXBlci5pc1ZhbGlkKCk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBleHBpcmF0aW9uIGRhdGUgOlxuICAgKiAtIGV4cCBpZiBzZXQsXG4gICAqIC0gc3VwZXIuZ2V0RXhwRGF0ZSgpIG90aGVyd2lzZVxuICAgKiBAcmV0dXJucyBEYXRlXG4gICAqL1xuICBnZXRUb2tlbkV4cERhdGUoKTogRGF0ZSB7XG4gICAgaWYgKHRoaXMuYWNjZXNzVG9rZW5QYXlsb2FkICYmIHRoaXMuYWNjZXNzVG9rZW5QYXlsb2FkLmhhc093blByb3BlcnR5KCdleHAnKSkge1xuICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKDApO1xuICAgICAgZGF0ZS5zZXRVVENTZWNvbmRzKHRoaXMuYWNjZXNzVG9rZW5QYXlsb2FkLmV4cCk7XG4gICAgICByZXR1cm4gZGF0ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHN1cGVyLmdldFRva2VuRXhwRGF0ZSgpO1xuICAgIH1cbiAgfVxufVxuIl19